---
title: "Comptes communes Martinique"
author: "Catherine Talbot"
date: "05/09/2019"
output: html_document
---

# Analyse financière des communes de Martinique

## Travail préparatoire

Importation des données issues de [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/comptes-individuels-des-communes/) (modifier le chemin d'accès des données selon l'endroit où vous les avez téléchargées).

```{r}
comptes_communes_2000_2017 <-
  read_excel(
    "C:/Users/cathe/OneDrive/Bureau/Data science/comptes-communes-2000-2017.xlsx",
    col_names = FALSE
  )
View(comptes_communes_2000_2017)

```

Répartition des données en plusieurs colonnes

```{r}
communes_colonnes <-
  c(
    "annee",
    "dep",
    "depcom",
    "commune",
    "population",
    "produits_total",
    "prod_impots_locaux",
    "prod_autres_impots_taxes",
    "prod_dotation",
    "charges_total",
    "charges_personnel",
    "charges_achats",
    "charges_financieres",
    "charges_contingents",
    "charges_subventions",
    "resultat_comptable",
    "invest_ressources_total",
    "invest_ress_emprunts",
    "invest_ress_subventions",
    "invest_ress_fctva",
    "invest_ress_retours",
    "invest_emplois_total",
    "invest_empl_equipements",
    "invest_empl_remboursement_emprunts",
    "invest_empl_charges",
    "invest_empl_immobilisations",
    "excedent_brut",
    "cap_autofinancement",
    "cap_autofinancement_nette",
    "dette_encours_total",
    "dette_encours_bancaire",
    "avance_tresor",
    "dette_annuite",
    "fond_de_roulement",
    "taxe_habitation",
    "taxe_habitation_base",
    "taxe_foncier_bati",
    "taxe_foncier_bati_base",
    "taxe_non_bati",
    "taxe_non_bati_base",
    "taxe_add_non_bati",
    "taxe_add_non_bati_base",
    "cotis_fonciere_entreprises",
    "cotis_fonciere_enreprises_base",
    "cotisation_valeur_ajoutee_entreprises",
    "import_forfait_entreprises_reseau",
    "taxe_surf_commerciales",
    "compensation_relais_2010",
    "taxe_professionnelle",
    "taxe_professionnelle_base",
    "produits_fonctionnement_caf",
    "charges_fonctionnement_caf",
    "encours_bancaire_net_solde_fonds_toxiques"
  )
comptes_communes_2000_2017 <-
  comptes_communes_2000_2017 %>% separate(1, communes_colonnes, ",")

```

Effacement des caractères parasites

```{r}
pattern_1 <- "\\s\\(L\'\\)"
pattern_2 <- "\\s\\(LA\\)"
pattern_3 <- "\\s\\(LE\\)"
pattern_4 <- "\\s\\(LES\\)"
pattern_5 <- "FRANÃ‡OIS"
comptes_communes_2000_2017 <-
  comptes_communes_2000_2017 %>% mutate(commune = str_replace_all(commune, pattern_1, ""))
comptes_communes_2000_2017 <-
  comptes_communes_2000_2017 %>% mutate(commune = str_replace_all(commune, pattern_2, ""))
comptes_communes_2000_2017 <-
  comptes_communes_2000_2017 %>% mutate(commune = str_replace_all(commune, pattern_3, ""))
comptes_communes_2000_2017 <-
  comptes_communes_2000_2017 %>% mutate(commune = str_replace_all(commune, pattern_4, ""))
comptes_communes_2000_2017 <-
  comptes_communes_2000_2017 %>% mutate(commune = str_replace_all(commune, pattern_5, "FRANCOIS"))

```

Sélection des communes de Martinique (à adapter pour les autres départements si besoin).

```{r}
comptes_communes_martinique <- comptes_communes_2000_2017 %>% filter(dep == "\"972\"")

```

Estimation des taux d'épargne brute
```{r}
comptes_communes_martinique <-
  comptes_communes_martinique %>% mutate(taux_epargne_brute = as.numeric(cap_autofinancement) / as.numeric(produits_total))


```

Estimation des taux d'épargne nette
```{r}
comptes_communes_martinique <-
  comptes_communes_martinique %>% mutate(taux_epargne_nette = as.numeric(cap_autofinancement_nette) / as.numeric(produits_total))


```

Estimation des taux d'effort
```{r}
comptes_communes_martinique <-
  comptes_communes_martinique %>% mutate(taux_effort = as.numeric(invest_empl_equipements) / as.numeric(produits_total))

```

Stratification de la population
```{r}
comptes_communes_martinique <-
  comptes_communes_martinique %>% mutate(strate = cut(
    as.numeric(comptes_communes_martinique$population),
    breaks = c(0, 500, 2000, 3500, 10000, 30000, 100000),
    labels = c(
      "<500",
      "500-2000",
      "2000-3500",
      "3500-10000",
      "10000-30000",
      "30000-100000"
    ),
    right = TRUE
  ))


```
## Analyse exploratoire

Les communes son groupées par année et par strate
```{r}
comptes_communes_martinique_groupes <-
  comptes_communes_martinique %>% group_by(annee, strate) %>% mutate(
    taux_EB_moyen = mean(taux_epargne_brute),
    taux_EN_moyen = mean(taux_epargne_nette),
    taux_effort_moyen = mean(taux_effort)
  )

```

Visualisation de l'évolution du taux d'épargne brute moyen par strate
```{r}
comptes_communes_martinique_groupes %>%
ggplot(aes(annee, taux_EB_moyen)) +
geom_point(alpha = 0.5) +
geom_smooth(method = "lm") +
facet_wrap( ~ strate)

```

Visualisation de l'évolution du taux d'épargne nette moyen par strate
```{r}
comptes_communes_martinique_groupes %>%
ggplot(aes(annee, taux_EN_moyen)) +
geom_point(alpha = 0.5) +
geom_smooth(method = "lm") +
facet_wrap( ~ strate)
```

Visualisation de l'évolution du taux d'effort moyen par strate
```{r}
comptes_communes_martinique_groupes %>%
ggplot(aes(annee, taux_effort_moyen)) +
geom_point(alpha = 0.5) +
geom_smooth(method = "lm") +
facet_wrap( ~ strate)
```

